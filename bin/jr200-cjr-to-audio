#!/usr/bin/env python3
'''
    Convert binary data to National JR-200 tape audio.
'''

from    os.path  import abspath, dirname, join
from    sys  import argv, exit
from    site  import addsitedir
from    scipy.io import wavfile
import  numpy as np



BASEDIR = dirname(dirname(abspath(__file__)))
addsitedir(join(BASEDIR, 'lib'))

from cmtconv.jr200 import \
    info, debug, err, cjr_to_file, FileEncoder, \
    checksums_valid, edges_to_samples

if len(argv) < 3:
    err('Convert binary data to JR-200 tape output\n' +
        'Usage: %s data_file output_file' % argv[0])
    exit(1)

fname = argv[1]
outfile = argv[2]

# Convert cjr file to File
with open(fname, 'rb') as f:
    data = f.read()
    cjr_file = cjr_to_file(data)

if not checksums_valid(cjr_file.blocks):
    raise Exception( 'Invalid checksum' )


# Convert File to edges
encoder = FileEncoder()
edges = encoder.encode_file(cjr_file)

debug(len(edges))
# Convert edges to samples
rate        = 44100
sample_dur  = 1.0 / rate
amp         = 127
mid         = 128
samples     = edges_to_samples(edges, sample_dur, mid, mid-amp, mid+amp)

debug(len(samples))

# Write out WAV file
wavfile.write(outfile, rate, np.asarray(samples, np.uint8))
