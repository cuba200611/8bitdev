#!/usr/bin/env python3
'''
    Convert as output to JR-200 tape audio
'''

from    sys  import argv, exit
from    os.path  import abspath, dirname, join
from    site  import addsitedir
from    scipy.io import wavfile
import  numpy as np

BASEDIR = dirname(dirname(abspath(__file__)))

if __name__ == '__main__':
    addsitedir(join(BASEDIR, 'lib'))

    from cmtconv.jr200 import \
        info, debug, err, FileType, BaudRate, bytes_to_file, \
        FileEncoder, edges_to_samples

    from testmc.tool import asl

    if len(argv) < 4:
        err('Convert binary data to JR-200 tape output\n' +
            'Usage: %s object_file output_file file_name' % argv[0])
        exit(1)

    obj_fname = argv[1]
    outfile = argv[2]
    fname = argv[3]

    image = asl.parse_obj_fromfile(obj_fname)
    length = image.contiglen()
    start = image.startaddr
    data = image.contigbytes()

    info('Start address: {}'.format(hex(start)))
    info('Contiguous length: {}'.format(length))

    f = bytes_to_file(fname, data, start, FileType.BINARY, BaudRate.BAUD_2400)
    info(f.header)
    for b in f.blocks:
        info(b)

    # Convert File to edges
    encoder = FileEncoder()
    edges = encoder.encode_file(f)

    debug(len(edges))
    # Convert edges to samples
    rate        = 44100
    sample_dur  = 1.0 / rate
    amp         = 127
    mid         = 128
    samples     = edges_to_samples(edges, sample_dur, mid, mid-amp, mid+amp)
    debug(len(samples))

    # Write out WAV file
    wavfile.write(outfile, rate, np.asarray(samples, np.uint8))
